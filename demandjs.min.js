/*
 DemandJS - v.1.0.0-rc.5

 https://github.com/hannasm/demandj

 MIT License

Copyright (c) 2017 Sean Hanna

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/
var _typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(f){return typeof f}:function(f){return f&&"function"===typeof Symbol&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f},_createClass=function(){function f(f,p){for(var a=0;a<p.length;a++){var b=p[a];b.enumerable=b.enumerable||!1;b.configurable=!0;"value"in b&&(b.writable=!0);Object.defineProperty(f,b.key,b)}}return function(m,p,a){p&&f(m.prototype,p);a&&f(m,a);return m}}();
function _classCallCheck(f,m){if(!(f instanceof m))throw new TypeError("Cannot call a class as a function");}
(function(f){var m=function(){function f(a){var b=this;_classCallCheck(this,f);this.phRegistry=new WeakMap;this.loaded=new WeakMap;this.injecting=new WeakMap;this.observed=new WeakMap;var c={};a&&"linkHandler"in a&&(c=a.linkHandler,delete a.linkHandler);this.defaultLoadingHtml='<div style="width:100%;height:100%">Loading In Progress</div>';this.defaultFailureHtml='<div style="background-color:#F00;color:#FFF;font-size:20pt;">ERROR</div>';this.options=Object.assign({previewLoading:!1,previewFailure:!1,
demandClassAttribute:"data-demand",defaultDemandClass:"default",loadingHtml:this.defaultLoadingHtml,failureHtml:this.defaultFailureHtml,createLoadingNode:function(a){return b.createLoadingNode(a)},createFailureNode:function(a,c){return b.createFailureNode(a,c)},shouldRemove:function(a){return!("tagName"in a)||!a.tagName.match(/link/i)},shouldInsertOnLoad:function(a){return b.options.shouldRemove(a)},selector:"img,video,picture,iframe,link.demand",ignoreSelector:".nodemand",rootMargin:"48px",threshold:.001,
onLoadBegin:function(a){return b.onLoadBegin(a)},onLoadSuccess:function(a){return b.onLoadSuccess(a)},onLoadFailure:function(a,c){return b.onLoadFailure(a,c)},onLoadComplete:function(a){return b.onLoadComplete(a)},linkHandler:{"text/html":function(a,c){return b.injectHtml(a,c)},"application/xhtml+xml":function(a,c){return b.injectHtml(a,c)}}},a);this.options.linkHandler=Object.assign(this.options.linkHandler,c);this.mutation=new MutationObserver(function(a,c){return b.observeMutation(a,c)});this.mutationOptions=
{childList:!0,subtree:!0};this.intersectionOptions={root:null,rootMargin:this.options.rootMargin,threshold:this.options.threshold};this.intersection=new IntersectionObserver(function(a,c){return b.observeIntersection(a,c)},this.intersectionOptions);a=this.queryTargets();this.observeTargets(a);this.mutation.observe(document.body,this.mutationOptions)}_createClass(f,[{key:"observeMutation",value:function(a){var b=!0,c=!1,d=void 0;try{for(var e=a[Symbol.iterator](),g;!(b=(g=e.next()).done);b=!0){var h=
g.value;if("childList"===h.type){a=!0;var l=!1,k=void 0;try{for(var f=h.addedNodes[Symbol.iterator](),n;!(a=(n=f.next()).done);a=!0){var q=n.value;q.parentNode&&this.checkAdditionRecursive(q)}}catch(t){l=!0,k=t}finally{try{!a&&f.return&&f.return()}finally{if(l)throw k;}}}}}catch(t){c=!0,d=t}finally{try{!b&&e.return&&e.return()}finally{if(c)throw d;}}}},{key:"checkAdditionRecursive",value:function(a){if(!this.observed.has(a)){this.observed.set(a,!0);var b=this.isTargetMatch(a);if(!b.loaded){if(b.isScript&&
b.injecting){this.injectedScript(a,b.injecting);return}if(b.isMatch){this.observeTarget(a);return}}if(a.children){a=Array.prototype.slice.call(a.children);b=!0;var c=!1,d=void 0;try{for(var e=a[Symbol.iterator](),g;!(b=(g=e.next()).done);b=!0)this.checkAdditionRecursive(g.value)}catch(h){c=!0,d=h}finally{try{!b&&e.return&&e.return()}finally{if(c)throw d;}}}}}},{key:"observeIntersection",value:function(a){var b=!0,c=!1,d=void 0;try{for(var e=a[Symbol.iterator](),g;!(b=(g=e.next()).done);b=!0){var h=
g.value;if(h.isIntersecting&&!(0>=h.intersectionRatio)){var l=this.phRegistry.get(h.target);void 0===l||l.loading||(l.loading=!0,this.beginLoad(l))}}}catch(k){c=!0,d=k}finally{try{!b&&e.return&&e.return()}finally{if(c)throw d;}}}},{key:"beginLoad",value:function(a){var b=this,c=this.resolveTarget(a);a=c.target;var d=c.registration;if(d.extraData.shouldInjectLink){var e=d.extraData.href;this.selectByDemandClass(a,this.options.onLoadBegin,this.options.demandClassAttribute,this.options.defaultDemandClass,
this.onLoadBegin).call(this,a);fetch(e).then(function(a){if(!a.ok){var b=Error('Fetching "'+e+'" failed with '+a.status+" "+a.statusText);b.responseDetail=a;throw b;}return a.text()}).then(function(a){b.injectLink(d,a)}).catch(function(a){b.handleError(d,a)})}else if(d.extraData.shouldRestore)setTimeout(function(){return b.restoreTarget(d)},0);else throw"Unknown load operation";}},{key:"isResourceLoaded",value:function(a){return a.complete||!1}},{key:"injectLink",value:function(a,b){var c=this.resolveTarget(a);
a=c.target;c=c.registration;if(!this.selectByDemandClass(a,this.options.previewLoading,this.options.demandClassAttribute,this.options.defaultDemandClass,!1))if(this.selectByDemandClass(a,this.options.previewFailure,this.options.demandClassAttribute,this.options.defaultDemandClass,!1))this.handleError(a,Error("found failure preview in options"));else{var d=c.extraData.type;if(d in this.options.linkHandler)(0,this.options.linkHandler[d])(a,b);else throw"Unknown link demand with content type: "+d;this.processSuccess(c)}}},
{key:"injectedScript",value:function(a,b){var c=this,d=b.id,e=Promise.resolve(a.innerHTML);"src"in a&&a.src&&(e=fetch(a.src).then(function(a){if(!a.ok)throw Error(a.status+"_"+a.statusText);return a.text()}),d=a.src+"#"+d);e.then(function(e){c.injectScript(a,b.href+".demand["+d+"].js",e)})}},{key:"injectScript",value:function(a,b,c){var d=document.write,e="";document.write=function(a){return e+=a};(new Function(c+"\n//@ sourceURL="+b))();""!==e&&this.injectHtml(a,"<body>"+e+"</body>");document.write=
d}},{key:"injectHtml",value:function(a,b){var c=document.createElement("html");c.innerHTML=b;var d=c.getElementsByTagName("body");b=1;d=Array.prototype.slice.call(d);c=!0;var e=!1,g=void 0;try{for(var h=d[Symbol.iterator](),l;!(c=(l=h.next()).done);c=!0){var f=Array.prototype.slice.call(l.value.children);d=!0;var r=!1,n=void 0;try{for(var q=f[Symbol.iterator](),m;!(d=(m=q.next()).done);d=!0){var p=m.value;this.injecting.set(p,{href:a.href,id:b});b+=1;a.parentNode.insertBefore(p,a)}}catch(u){r=!0,
n=u}finally{try{!d&&q.return&&q.return()}finally{if(r)throw n;}}}}catch(u){e=!0,g=u}finally{try{!c&&h.return&&h.return()}finally{if(e)throw g;}}}},{key:"processSuccess",value:function(a){var b=this.resolveTarget(a);a=b.target;b=b.registration;if(!this.selectByDemandClass(a,this.options.previewLoading,this.options.demandClassAttribute,this.options.defaultDemandClass,!1))if(this.selectByDemandClass(a,this.options.previewFailure,this.options.demandClassAttribute,this.options.defaultDemandClass,!1))this.handleError(a,
Error("found failure preview in options"));else if(b){b.extraData.insertToLoad&&(a.style.display=b.extraData.display);var c=this.options.shouldInsertOnLoad(b.target),d=!0,e=!1,g=void 0;try{for(var h=b.placeholders[Symbol.iterator](),f;!(d=(f=h.next()).done);d=!0){var k=f.value;c&&(c=!1,k.parentNode.insertBefore(b.target,k));this.cleanupPlaceholder(k)}}catch(r){e=!0,g=r}finally{try{!d&&h.return&&h.return()}finally{if(e)throw g;}}this.cleanupRegistrationTarget(b);this.selectByDemandClass(a,this.options.onLoadSuccess,
this.options.demandClassAttribute,this.options.defaultDemandClass,this.onLoadSuccess).call(this,a);this.selectByDemandClass(a,this.options.onLoadComplete,this.options.demandClassAttribute,this.options.defaultDemandClass,this.onLoadComplete).call(this,a)}}},{key:"cleanupPlaceholder",value:function(a){this.intersection.unobserve(a);a.parentNode.removeChild(a);this.phRegistry.delete(a)}},{key:"cleanupRegistrationTarget",value:function(a){this.intersection.unobserve(a.target);this.phRegistry.delete(a.target);
this.loaded.set(a.target,!0)}},{key:"handleError",value:function(a,b){var c=this.resolveTarget(a);a=c.target;if(c=c.registration){b&&b.stack&&b.message||(b=b?Error(b):Error("No error was provided on load"));var d=this.selectByDemandClass(a,this.options.onLoadFailure,this.options.demandClassAttribute,this.options.defaultDemandClass,this.onLoadFailure);c.extraData.insertToLoad&&(a.style.display=c.extraData.display);var e=!0,g=!0,h=!1,f=void 0;try{for(var k=c.placeholders[Symbol.iterator](),m;!(g=(m=
k.next()).done);g=!0){var n=m.value;e&&(e=!1,a.parentNode&&!c.extraData.insertToLoad||n.parentNode.insertBefore(a,n),d.call(this,a,b));this.cleanupPlaceholder(n)}}catch(q){h=!0,f=q}finally{try{!g&&k.return&&k.return()}finally{if(h)throw f;}}e&&d.call(this,a,b);this.cleanupRegistrationTarget(c);this.selectByDemandClass(a,this.options.onLoadComplete,this.options.demandClassAttribute,this.options.defaultDemandClass,this.onLoadComplete).call(this,a)}}},{key:"onLoadBegin",value:function(a){}},{key:"onLoadSuccess",
value:function(a){}},{key:"onLoadComplete",value:function(a){}},{key:"onLoadFailure",value:function(a,b){b=this.selectByDemandClass(a,this.options.createFailureNode,this.options.demandClassAttribute,this.options.defaultDemandClass,this.createFailureNode).call(this,a,b);b=Array.prototype.slice.call(b);var c=!0,d=!1,e=void 0;try{for(var g=b[Symbol.iterator](),h;!(c=(h=g.next()).done);c=!0){var f=h.value;this.loaded.set(f,!0);a.parentNode.insertBefore(f,a)}}catch(k){d=!0,e=k}finally{try{!c&&g.return&&
g.return()}finally{if(d)throw e;}}this.options.shouldRemove(a)&&a.parentNode.removeChild(a)}},{key:"selectByDemandClass",value:function(a,b,c,d,e){if(!b)return e;if("object"===("undefined"===typeof b?"undefined":_typeof(b))){var g=d;a.hasAttribute(c)&&(g=a.getAttribute(c));do{if(g in b){b=b[g];break}else if(g===d){b=e;break}g=d}while(1)}return b}},{key:"createFailureNode",value:function(a,b){b=document.createElement("div");a=this.selectByDemandClass(a,this.options.failureHtml,this.options.demandClassAttribute,
this.options.defaultDemandClass,this.defaultFailureHtml);b.innerHTML=a;return b.childNodes}},{key:"createLoadingNode",value:function(a){var b=document.createElement("div");a=this.selectByDemandClass(a,this.options.loadingHtml,this.options.demandClassAttribute,this.options.defaultDemandClass,this.defaultLoadingHtml);b.innerHTML=a;return b.childNodes}},{key:"registerPlaceholder",value:function(a,b,c,d){b={isRegistration:!0,target:b,node:a,placeholders:c,extraData:d,loading:!1};this.phRegistry.set(a,
b);return b}},{key:"resolveTarget",value:function(a){var b=a;"isRegistration"in a&&a.isRegistration?a=b.target:b=this.phRegistry.get(a);return{target:a,registration:b}}},{key:"restoreTarget",value:function(a){var b=this.resolveTarget(a);a=b.target;b=b.registration;var c=b.extraData;b.loading=!0;this.selectByDemandClass(a,this.options.onLoadBegin,this.options.demandClassAttribute,this.options.defaultDemandClass,this.onLoadBegin).call(this,a);this._restoreTargetInternal(a,c);c.canLoad||this.processSuccess(b)}},
{key:"_restoreTargetInternal",value:function(a,b){b.hasSrcset&&a.setAttribute("srcset",b.srcset);b.hasSizes&&a.setAttribute("sizes",b.sizes);b.hasSrc&&a.setAttribute("src",b.src);if(0<b.children.length)for(var c=0;c<b.children.length;c++){var d=b.children[c];this._restoreTargetInternal(d.target,d)}b.insertToLoad&&(a.style.display="none",this.loaded.set(a),document.body.appendChild(a))}},{key:"captureTarget",value:function(a,b){var c=this,d={target:a,hasSrc:a.hasAttribute("src"),src:a.getAttribute("src"),
hasSrcset:a.hasAttribute("srcset"),srcset:a.getAttribute("srcset"),hasSizes:a.hasAttribute("sizes"),sizes:a.getAttribute("sizes"),isLink:"tagName"in a&&a.tagName.match(/link/i),insertToLoad:"tagName"in a&&a.tagName.match(/iframe/i),hasHref:a.hasAttribute("href"),href:a.getAttribute("href"),hasType:a.hasAttribute("type"),type:a.getAttribute("type"),hasDisplay:a.style&&a.style.display,display:a.style.display||"",children:[],shouldRestore:!1,canLoad:!1,shouldInjectLink:!1};d.hasSrc&&a.removeAttribute("src");
d.hasSrcset&&a.removeAttribute("srcset");d.hasSizes&&a.removeAttribute("sizes");d.isLink&&d.hasHref&&(d.shouldInjectLink=!0,d.hasType||(d.type="text/html"));(d.hasSrc||d.hasSrcset)&&a===b&&(d.shouldRestore=!0,d.canLoad=!0,"tagName"in a&&a.tagName.match(/video|audio/i)?(a.addEventListener("loadedmetadata",function(a){return c.processSuccess(b)}),a.addEventListener("loadeddata",function(a){return c.processSuccess(b)})):a.addEventListener("load",function(a){return c.processSuccess(b)}),d.hasSrcset&&
d.hasSrc?a.addEventListener("error",function(a){c.handleError(b,Error("Loading for srcset and src failed ("+d.srcset+")("+d.src+")"))}):d.hasSrcset?a.addEventListener("error",function(a){c.handleError(b,Error("Loading for srcset failed ("+d.srcset+")"))}):d.hasSrc?a.addEventListener("error",function(a){c.handleError(b,Error("Loading for src failed ("+d.src+")"))}):a.addEventListener("error",function(a){c.handleError(b,Error("Loading srced element failed (FALLBACK ERROR MSG)"))}));if("tagName"in a&&
a.tagName.match(/picture|video|audio/i)){a===b&&(d.shouldRestore=!0);for(var e=0;e<a.children.length;e++){var g=this.captureTarget(a.children[e]);g.index=e;d.children.push(g)}}return d}},{key:"isContextExcluded",value:function(a){return a&&"parentNode"in a?(a=a.parentNode)&&"tagName"in a?a.tagName.match(/picture|video|audio/i)?!0:this.isContextExcluded(a):!1:!1}},{key:"observeTarget",value:function(a){if(!this.isResourceLoaded(a)&&!this.isContextExcluded(a)){var b=this.captureTarget(a,a),c=this.selectByDemandClass(a,
this.options.createLoadingNode,this.options.demandClassAttribute,this.options.defaultDemandClass,this.createLoadingNode).call(this,a);c=Array.prototype.slice.call(c);var d=!0,e=!1,g=void 0;try{for(var f=c[Symbol.iterator](),l;!(d=(l=f.next()).done);d=!0){var k=l.value;this.registerPlaceholder(k,a,c,b);this.loaded.set(k,!0);a.parentNode.insertBefore(k,a);this.intersection.observe(k)}}catch(r){e=!0,g=r}finally{try{!d&&f.return&&f.return()}finally{if(e)throw g;}}this.registerPlaceholder(a,a,c,b);this.options.shouldRemove(a)?
a.parentNode.removeChild(a):this.intersection.observe(a)}}},{key:"observeTargets",value:function(a){var b=!0,c=!1,d=void 0;try{for(var e=a[Symbol.iterator](),g;!(b=(g=e.next()).done);b=!0)this.observeTarget(g.value)}catch(h){c=!0,d=h}finally{try{!b&&e.return&&e.return()}finally{if(c)throw d;}}}},{key:"isLoadedRecursive",value:function(a,b){return this.loaded.has(a)?{loaded:!0,injecting:b||this.injecting.get(a)}:!b&&a.parentNode?this.isLoadedRecursive(a.parentNode,b||this.injecting.get(a)):{loaded:!1,
injecting:b||this.injecting.get(a)}}},{key:"isScript",value:function(a){return!!("tagName"in a&&a.tagName.match(/^script$/i))}},{key:"isTargetMatch",value:function(a){var b="matches"in a&&a.matches(this.options.selector);b=b&&!(this.options.ignoreSelector&&a.matches(this.options.ignoreSelector));var c=this.isScript(a);if(!b&&!c)return{isMatch:b,isScript:c,loaded:!1,injecting:!1};a=this.isLoadedRecursive(a,!1);a.isMatch=b;a.isScript=c;return a}},{key:"queryTargets",value:function(){var a=[],b=!0,c=
!1,d=void 0;try{for(var e=document.querySelectorAll(this.options.selector)[Symbol.iterator](),g;!(b=(g=e.next()).done);b=!0){var f=g.value;this.options.ignoreSelector&&"matches"in f&&f.matches(this.options.ignoreSelector)||a.push(f)}}catch(l){c=!0,d=l}finally{try{!b&&e.return&&e.return()}finally{if(c)throw d;}}return a}},{key:"shouldRemove",value:function(a){return!("tagName"in a)||!a.tagName.match(/link/i)}}]);return f}();f.DemandJS=m})(window);
